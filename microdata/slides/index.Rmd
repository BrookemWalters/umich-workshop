---
title: "ACS Microdata and International Census Data"
author: "Kyle Walker"
date: March 25, 2021
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: 16:9
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
options(tigris_use_cache = TRUE)
library(tigris)
library(tmap)
tmap_options(legend.text.size = 1)

knitr::opts_chunk$set(message = FALSE, warning = FALSE, fig.width = 12)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)

style_xaringan(
  title_slide_background_color = "#035004",
  text_color = "black",
  header_color = "#035004",
  inverse_background_color = "#035004",
  text_font_family = "Gotham Narrow",
  header_font_family = "Helvetica",
  header_font_weight = "bold",
  link_color = "#1a730f",
  code_inline_color = "#035004"
)
```

## About me

* Associate Professor of Geography at TCU 

* Spatial data science researcher and consultant

* R package developer: tidycensus, tigris, mapboxapi

* Book coming this year: _Analyzing the US Census with R_
  - These workshops are a sneak preview of the book's content!

---

## SSDAN workshop series

* Today: US Census microdata and international Census data in R

* March 4: an introduction to analyzing US Census data with tidycensus ([code](https://github.com/walkerke/umich-workshop/blob/main/census-data-in-r/code/part-1-code.R) | [video recording](https://www.youtube.com/watch?v=PnFJfuJ83NI))

* March 11: spatial analysis of US Census data in R  ([code](https://github.com/walkerke/umich-workshop/blob/main/spatial-analysis/code/part-2-code.R) | [video recording](https://www.youtube.com/watch?v=GqC1HjAKui4))

---

## Today's agenda

* Hour 1: Using ACS microdata with tidycensus

* Hour 2: Analyzing and modeling microdata

* Hour 3: Bonus: international Census data resources in R

---
class: middle, center, inverse

## Part 1: Using ACS microdata with tidycensus

---

## What is "microdata?"  

.pull-left[

* __Microdata__: individual-level survey responses made available to researchers 

* The ACS Public Use Microdata Series (PUMS) allows for detailed cross-tabulations not available in aggregated data

* The 1-year PUMS covers about 1 percent of the US population; the 5-year PUMS covers about 5 percent (so, not the full ACS)

]

.pull-right[

{microdata example/screenshot}

]

---

## Microdata resources: Census website

{discuss here}

---

## Microdata resources: IPUMS

{discuss here}

---

## Microdata resources: ipumsr

{brief example here of ipumsr use}

---

## Microdata and the Census API

{explain here how data.census.gov made it available}

---
class: middle, center, inverse

## Using microdata in tidycensus

---

## Setting up tidycensus

```{r, eval = FALSE}
library(tidycensus)

census_api_key("YOUR KEY GOES HERE", install = TRUE)
```


---

## Basic usage of `get_pums()`

.pull-left[

* `get_pums()` requires specifying one or more variables and the state for which you'd like to request data.  `state = 'all'` _can_ get data for the entire USA, but it takes a while!

* The function defaults to the 5-year ACS with `survey = "acs5"`; 1-year ACS data is available with `survey = "acs1"`. 

* The default year is 2019; data are available back to {year}

]


.pull-right[

```{r}
library(tidycensus)

wy_pums <- get_pums(
  variables = c("SEX", "AGEP", "SCHL"),
  state = "WY",
  survey = "acs1",
  year = 2019
)
```

]

---

```{r}
wy_pums
```

---

## Understanding default data from `get_pums()`

`get_pums()` returns some technical variables by default without the user needing to request them specifically.  These include: 

* `SERIALNO`: a serial number that uniquely identifies households in the sample; 

* `SPORDER`: the order of the person in the household; when combined with `SERIALNO`, uniquely identifies a person;

* `WGTP`: the household weight;

* `PWGTP`: the person weight

---

## Weights and ACS microdata

* Given that PUMS data are a _sample_ of the US population, the weights columns must be used for analysis

```{r}
library(tidyverse)

wy_age_50 <- filter(wy_pums, AGEP == 50)

print(sum(wy_pums$PWGTP))
print(sum(wy_age_50$PWGTP))
```

---
class: middle, center, inverse

## Working with PUMS variables

---

## Variables available in the ACS PUMS

```{r, eval = FALSE}
View(pums_variables)
```

---

## Understanding PUMS variables

{info here}

---

## Recoding PUMS variables

```{r}
wy_pums_recoded <- get_pums(
  variables = c("SEX", "AGEP", "SCHL"),
  state = "WY",
  survey = "acs1",
  year = 2019,
  recode = TRUE
)
```

---

```{r}
wy_pums_recoded
```

---

## Using variables filters

* PUMS datasets - especially from the 5-year ACS - can get quite large.  The `variables_filter` argument can return a subset of data from the API, reducing long download times

```{r}
wy_pums_filtered <- get_pums(
  variables = c("SEX", "AGEP", "SCHL"),
  state = "WY",
  survey = "acs5",
  variables_filter = list(
    SEX = 2,
    SCHL = 16:20
  ),
  year = 2019,
  recode = TRUE
)
```


---

```{r}
wy_pums_filtered
```


---
class: middle, center, inverse

## Public Use Microdata Areas (PUMAs)

---

## What is a PUMA?

.pull-left[

* Public Use Microdata Areas (PUMAs) are the smallest available geographies at which records are identifiable in the PUMS datasets

* PUMAs are redrawn with each decennial US Census, and typically are home to 100,000-200,000 people

* In large cities, a PUMA will represent a collection of nearby neighborhoods; in rural areas, it might represent several counties across a large area of a state

]

.pull-right[

```{r}
library(tigris)
options(tigris_use_cache = TRUE)

wy_pumas <- pumas(state = "WY", cb = TRUE)

plot(wy_pumas$geometry)
```

]

---

## Working with PUMAs in PUMS data

* To get PUMA information in your output data, use the variable code `PUMA`

```{r}
wy_age_by_puma <- get_pums(
  variables = c("PUMA", "AGEP"),
  state = "WY",
  survey = "acs5"
)
```

---

```{r}
wy_age_by_puma
```


---

## Custom queries by PUMA

* The `puma` argument in `get_pums()` can be used to obtain data for a specific PUMA or multiple PUMAs - again reducing long download times if specific geographies are required

```{r}
wy_puma_subset <- get_pums(
  variables = "AGEP",
  state = "WY",
  survey = "acs5",
  puma = "00500"
)
```

---

```{r}
wy_puma_subset
```


---

## Part 1 exercises

* Try requesting PUMS data using `get_pums()` yourselves, but for a state other than Wyoming.  

* Use the `pums_variables` dataset to browse the available variables in the PUMS.  Create a custom query with `get_pums()` to request data for variables other than those we've used in the above examples.  

---
class: middle, center, inverse

## Analyzing and modeling PUMS data in R

---

## Considerations when working with PUMS data

* The individual-level microdata returned by `get_pums()` can be used to produce detailed cross-tabulations not available in the aggregate ACS, e.g. from `get_acs()`

* tidyverse tools like dplyr are excellent for producing these tabulations and handling survey weights

* Because data acquired with `get_pums()` are drawn from the ACS, any estimates produced in your analysis will be characterized by error - which can be substantial when cross-tabulations are highly specific


---

## PUMS data and the tidyverse

```{r}
ms_pums <- get_pums(
  variables = c("PUMA", "SEX", "AGEP", "SCHL"),
  state = "MS",
  survey = "acs5",
  year = 2019,
  recode = TRUE
)

ms_age_sex <- ms_pums %>%
  count(SEX_label, AGEP, wt = PWGTP) # test this out
  
```

---

```{r}
ms_age_sex
```



---

## Group-wise data tabulation

```{r}
ms_pums_summary <- ms_pums %>% 
  mutate(ba_above = SCHL %in% c("21", "22", "23", "24")) %>% 
  group_by(PUMA, SEX_label) %>% 
  summarize(
    total_pop = sum(PWGTP),
    mean_age = weighted.mean(AGEP, PWGTP),
    ba_above = sum(PWGTP[ba_above == TRUE & AGEP >= 25]),
    ba_above_pct = 100 * (ba_above / sum(PWGTP[AGEP >= 25]))
  )
```

---

```{r}
ms_pums_summary
```


---

## Advanced example: mapping PUMS data

```{r}
library(tigris)
options(tigris_use_cache = TRUE)

ms_pumas <- pumas("MS", cb = TRUE)

joined_pumas <- ms_pumas %>%
  left_join(ms_pums_summary, by = c("PUMACE10" = "PUMA")) %>%
  filter(SEX_label == "Female")
```

---

```{r}
tm_shape(joined_pumas) + 
  tm_polygons(col = "ba_above_pct", 
              palette = "Greens",
              title = "% of women with\ncollege degree") + 
  tm_layout(legend.outside = TRUE,
            legend.outside.position = "right")
```


---
class: middle, center, inverse

## Calculating errors around tabulated estimates

---

## Survey design and the ACS PUMS

{general info here}

---

## Getting replicate weights

```{r, eval = FALSE}
ms_pums_replicate <- get_pums(
  variables = c("PUMA", "SEX", "AGEP", "SCHL"),
  state = "MS",
  survey = "acs5",
  year = 2019,
  recode = TRUE,
  rep_weights = "person"
)
```

```{r, echo = FALSE}
ms_pums_replicate <- read_rds("microdata/data/ms_pums_replicate.rds")
```

```{r}
ms_pums_replicate
```

---

## Creating a `survey` object

```{r}
library(survey)
library(srvyr)

ms_pums_svy <- ms_pums_replicate %>%
  to_survey(type = "person", 
            design = "rep_weights")

class(ms_pums_svy)
```

---

## Calculating estimates and errors with __srvyr__

```{r}
ms_pums_svy %>% 
  survey_count(PUMA, SEX_label)
```


---

## Complex tabulations with __srvyr__

```{r}
ms_svy_summary <- ms_pums_svy %>% 
  mutate(ba_above = SCHL %in% c("21", "22", "23", "24")) %>% 
  filter(AGEP >= 25) %>% 
  group_by(PUMA, SEX_label) %>% 
  summarize(
    age_25_up = survey_total(vartype = "se"),
    ba_above_n = survey_total(ba_above, vartype = "se"),
    ba_above_pct = survey_mean(ba_above, vartype = "se")
    )

glimpse(ms_svy_summary)
```

---

## Converting standard errors to MOEs

{example here}

---
class: middle, center, inverse

## Modeling with PUMS data

---

## Preparing data

{how-to here}

---

## Fitting a model

{how-to here}

---

## Evaluating the model

{info here}

---
class: middle, center, inverse

## Part 2 exercises

{exercises here}

---
class: middle, center, inverse

## International Census data resources in R

---

## International Census data

{discussion of how we've focused on US Census data, but there is much more!}

---

## The US Census International Data Base

{info here}

---

## International data with idbr

* Example: how has life expectancy at birth changed in Southeast Asia?

```{r}
laos_lex <- idb5(
  country = c("Laos", "Vietnam", "Cambodia", "Thailand"),
  year = 1995:2021,
  variable = "E0",
  country_name = TRUE
)

ggplot(laos_lex, aes(x = time, y = E0, color = NAME)) + 
  theme_minimal(base_size = 18) + 
  geom_line(size = 2) + 
  labs(title = "Change in life expectancy, 1995-2021",
       y = "Life expectancy at birth",
       x = "Year")
```


---

## International data with idbr

.pull-left[

* Example: what 10 countries have the highest total fertility rates in 2021?

```{r}
top_tfr <- idb5(
  country = "all",
  year = 2021,
  variable = "TFR",
  country_name = TRUE
) %>%
  slice_max(TFR, n = 10)
```

]

.pull-right[

```{r}
top_tfr
```

]

---

## Canada: cancensus

```{r}
library(cancensus)
library(tidyverse)
library(sf)
options(cancensus.api_key = "CensusMapper_6293253518cbfcfc86b62e83f056f92f")

View(list_census_vectors("CA16"))

```

---

## Canada: cancensus

```{r}
montreal_english <- get_census(
  dataset = "CA16",
  regions = list(CMA = "24462"),
  vectors = "v_CA16_1364",
  level = "CT",
  geo_format = "sf",
  labels = "short"
)
```

---

```{r}
tm_shape(montreal_english) + 
  tm_polygons() + 
  tm_bubbles(size = "v_CA16_1364", alpha = 0.5, col = "blue")
```


---

## Mexico: inegiR

{info}

---

## Mexico: inegiR

{example}

---

## Brazil: geobr

{info}

---

## Brazil: geobr

{example}

---

## Kenya: RKenyaCensus

{info}

---

## Kenya: RKenyaCensus

{example}

---

## United Kingdom: nomisr

{info}

---

## United Kingdom: nomisr

{example}

---

## International microdata with IPUMS-I



